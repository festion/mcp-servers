# FINAL TEMPLATE DUPLICATE RESOLUTION
# Date: June 5, 2025 - Eliminates all unique_id conflicts
# Action: Replaces emergency_health_fix.yaml with conflict-free unique_ids
# IMPORTANT: This file replaces packages/emergency_health_fix.yaml to eliminate duplicates

template:
  - sensor:
      # FIXED: Integration Health Status - UNIQUE ID UPDATED
      - name: "Integration Health Status V2"
        unique_id: integration_health_status_v2_final
        state: >
          {% set unavailable_count = states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | count %}
          
          {% if unavailable_count == 0 %}
            Excellent
          {% elif unavailable_count <= 10 %}
            Very Good
          {% elif unavailable_count <= 30 %}
            Good
          {% elif unavailable_count <= 60 %}
            Fair
          {% elif unavailable_count <= 100 %}
            Poor
          {% else %}
            Critical
          {% endif %}
        icon: >
          {% set status = this.state %}
          {% if status in ['Excellent', 'Very Good'] %}
            mdi:check-circle
          {% elif status in ['Good', 'Fair'] %}
            mdi:alert-circle-outline
          {% else %}
            mdi:alert-octagon
          {% endif %}
        availability: true
        attributes:
          unavailable_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | count }}"
          unknown_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unknown') | list | count }}"
          total_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | list | count }}"
          note: "Only unavailable entities count as unhealthy. Unknown states are normal for many entity types."

      # FIXED: Integration Health Percentage - UNIQUE ID UPDATED
      - name: "Integration Health Percentage V2"
        unique_id: integration_health_percentage_v2_final
        state: >
          {% set all_entities = states | rejectattr('entity_id', 'search', 'health|integration_health') | list %}
          {% set total = all_entities | count %}
          {% set unavailable_only = all_entities | selectattr('state', 'eq', 'unavailable') | list | count %}
          {% if total > 0 %}
            {{ ((total - unavailable_only) / total * 100) | round(1) }}
          {% else %}
            100
          {% endif %}
        unit_of_measurement: "%"
        state_class: measurement
        availability: true
        attributes:
          unavailable_count: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | count }}"
          unknown_count: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unknown') | list | count }}"
          total_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | list | count }}"
          calculation_note: "Health = (Total - Unavailable) / Total. Unknown states are NOT counted as unhealthy."

      # FIXED: Alexa Integration Health - UNIQUE ID UPDATED
      - name: "Alexa Integration Health V2"
        unique_id: alexa_integration_health_v2_final
        state: >
          {% set alexa_entities = states | selectattr('entity_id', 'search', 'alexa') | rejectattr('entity_id', 'search', 'health|integration_health') | list %}
          {% set total = alexa_entities | length %}
          {% set unavailable = alexa_entities | selectattr('state', 'eq', 'unavailable') | list | length %}
          {% if total > 0 %}
            {{ ((total - unavailable) / total * 100) | round(1) }}
          {% else %}
            100
          {% endif %}
        unit_of_measurement: "%"
        state_class: measurement
        availability: true
        attributes:
          total_alexa_entities: >
            {{ states | selectattr('entity_id', 'search', 'alexa') | rejectattr('entity_id', 'search', 'health|integration_health') | list | length }}
          unavailable_alexa_entities: >
            {{ states | selectattr('entity_id', 'search', 'alexa') | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | length }}

      # FIXED: Mobile App Integration Health - UNIQUE ID UPDATED
      - name: "Mobile App Integration Health V2"
        unique_id: mobile_app_integration_health_v2_final
        state: >
          {% set mobile_entities = states | selectattr('entity_id', 'search', 'mobile_app|pixel_9') | rejectattr('entity_id', 'search', 'health|integration_health') | list %}
          {% set total = mobile_entities | length %}
          {% set unavailable = mobile_entities | selectattr('state', 'eq', 'unavailable') | list | length %}
          {% if total > 0 %}
            {{ ((total - unavailable) / total * 100) | round(1) }}
          {% else %}
            100
          {% endif %}
        unit_of_measurement: "%"
        state_class: measurement  
        availability: true
        attributes:
          total_mobile_entities: >
            {{ states | selectattr('entity_id', 'search', 'mobile_app|pixel_9') | rejectattr('entity_id', 'search', 'health|integration_health') | list | length }}
          unavailable_mobile_entities: >
            {{ states | selectattr('entity_id', 'search', 'mobile_app|pixel_9') | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | length }}

      # FIXED: Switch Integration Health - UNIQUE ID UPDATED
      - name: "Switch Integration Health V2"
        unique_id: switch_integration_health_v2_final
        state: >
          {% set switch_entities = states.switch | rejectattr('entity_id', 'search', 'health|integration_health') | list %}
          {% set total = switch_entities | length %}
          {% set unavailable = switch_entities | selectattr('state', 'eq', 'unavailable') | list | length %}
          {% if total > 0 %}
            {{ ((total - unavailable) / total * 100) | round(1) }}
          {% else %}
            100
          {% endif %}
        unit_of_measurement: "%"
        state_class: measurement
        availability: true
        attributes:
          total_switches: "{{ states.switch | rejectattr('entity_id', 'search', 'health|integration_health') | list | length }}"
          unavailable_switches: "{{ states.switch | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | length }}"

      # FIXED: Simple unavailable entities counter - NO LOOP REFERENCES
      - name: "Unavailable Entities Clean"
        unique_id: unavailable_entities_clean_final
        state: >
          {{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | count }}
        unit_of_measurement: "entities"
        state_class: measurement
        availability: true
        attributes:
          total_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | list | count }}"
          unknown_entities: "{{ states | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unknown') | list | count }}"
          percentage: >
            {% set all_entities = states | rejectattr('entity_id', 'search', 'health|integration_health') | list %}
            {% set total = all_entities | count %}
            {% set unavailable = all_entities | selectattr('state', 'eq', 'unavailable') | list | count %}
            {% if total > 0 %}
              {{ (unavailable / total * 100) | round(2) }}
            {% else %}
              0
            {% endif %}

      # FIXED: Failed automations counter - NO LOOP REFERENCES
      - name: "Failed Automations Count Clean"
        unique_id: failed_automations_count_clean_final
        state: >
          {{ states.automation | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'unavailable') | list | count }}
        unit_of_measurement: "automations"
        state_class: measurement
        availability: true
        attributes:
          total_automations: "{{ states.automation | rejectattr('entity_id', 'search', 'health|integration_health') | list | count }}"
          working_automations: "{{ states.automation | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'on') | list | count }}"
          disabled_automations: "{{ states.automation | rejectattr('entity_id', 'search', 'health|integration_health') | selectattr('state', 'eq', 'off') | list | count }}"

  - binary_sensor:
      # FIXED: System health binary sensor - NO LOOP REFERENCES
      - name: "System Health OK Clean"
        unique_id: system_health_ok_clean_final
        state: >
          {% set health_pct = states('sensor.integration_health_percentage') | default(0) | float(0) %}
          {% set unavailable = states('sensor.unavailable_entities_clean') | default(0) | int(0) %}
          {% set failed_autos = states('sensor.failed_automations') | default(0) | int(0) %}
          {{ health_pct >= 90 and unavailable <= 100 and failed_autos == 0 }}
        device_class: connectivity
        availability: true
        attributes:
          health_percentage: "{{ states('sensor.integration_health_percentage') | default(0) | float(0) }}"
          unavailable_entities: "{{ states('sensor.unavailable_entities_clean') | default(0) | int(0) }}"
          failed_automations: "{{ states('sensor.failed_automations') | default(0) | int(0) }}"
          threshold_note: "Health considered OK when: Health >= 90%, Failed automations = 0, Unavailable <= 100"